// This is your Prisma schema file for BizWiz NeuroBoard Backend
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// ================================
// USER MANAGEMENT
// ================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String
  password          String?   // Hashed password for email auth
  emailVerified     Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  passwordResetToken String?
  passwordResetExpires DateTime?
  authProvider      String?   // e.g., "google", "email", "clerk"
  authId            String?   // External auth provider ID
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  boards         Board[]
  nodes          Node[]
  businessIdeas  BusinessIdea[]
  preferences    UserPreferences?
  collections    IdeaCollection[]
  sharedIdeas    IdeaShare[]     @relation("SharedBy")
  receivedShares IdeaShare[]     @relation("SharedWith")
  comments       IdeaComment[]
  generationLogs IdeaGenerationLog[]

  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
}

// ================================
// BOARDS & WHITEBOARD
// ================================

model Board {
  id          String   @id @default(uuid())
  ownerId     String
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner     User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  nodes     Node[]
  groups    NodeGroup[]
  edges     Edge[]
  snapshots BoardSnapshot[]

  @@index([ownerId])
  @@index([createdAt])
}

// ================================
// NODES (Content on the Whiteboard)
// ================================

model Node {
  id              String   @id @default(uuid())
  boardId         String
  ownerId         String
  type            NodeType
  title           String
  rawText         String?  @db.Text // Extracted text content for RAG
  metadata        Json?    // Flexible storage: { url, filename, duration, status, summary, chapters, etc. }
  fileStorageKey  String?  // S3 object key for raw files
  previewImageKey String?  // S3 object key for thumbnails/screenshots
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  board            Board           @relation(fields: [boardId], references: [id], onDelete: Cascade)
  owner            User            @relation(fields: [ownerId], references: [id])
  position         NodePosition?
  embeddings       NodeEmbedding[]
  groupMemberships GroupMember[]
  edgesFrom        Edge[]          @relation("EdgeFrom")
  edgesTo          Edge[]          @relation("EdgeTo")

  @@index([boardId])
  @@index([ownerId])
  @@index([type])
  @@index([createdAt])
}

enum NodeType {
  NOTE
  DOCUMENT
  YOUTUBE_VIDEO
  WEB_URL
  IMAGE
  AUDIO
  VIDEO
  PDF
  OTHER
}

// ================================
// SPATIAL LAYOUT (Node Positions)
// ================================

model NodePosition {
  id        String   @id @default(uuid())
  nodeId    String   @unique
  boardId   String
  x         Float
  y         Float
  width     Float    @default(300)
  height    Float    @default(200)
  zIndex    Int      @default(0)
  color     String?  // Optional color for styling (hex code)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  node Node @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([nodeId])
}

// ================================
// GROUPING (Cluster related nodes)
// ================================

model NodeGroup {
  id          String   @id @default(uuid())
  boardId     String
  name        String
  description String?  @db.Text
  color       String?  // Optional color for group visualization
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  board   Board         @relation(fields: [boardId], references: [id], onDelete: Cascade)
  members GroupMember[]

  @@index([boardId])
}

model GroupMember {
  id        String   @id @default(uuid())
  groupId   String
  nodeId    String
  createdAt DateTime @default(now())

  // Relations
  group NodeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  node  Node      @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([groupId, nodeId])
  @@index([groupId])
  @@index([nodeId])
}

// ================================
// EDGES (Connections between nodes)
// ================================

model Edge {
  id           String   @id @default(uuid())
  boardId      String
  sourceNodeId String
  targetNodeId String
  label        String?  // Optional label for the connection
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  board      Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  sourceNode Node  @relation("EdgeFrom", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode Node  @relation("EdgeTo", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
}

// ================================
// RAG: EMBEDDINGS (Vector Storage)
// ================================

model NodeEmbedding {
  id         String                         @id @default(uuid())
  nodeId     String
  chunkIndex Int // Order of chunks in the document
  chunkText  String                         @db.Text
  embedding  Unsupported("vector(768)")?    // pgvector extension - 768 dimensions for Gemini text-embedding-004
  createdAt  DateTime                       @default(now())

  // Relations
  node Node @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId, chunkIndex])
  @@index([nodeId])
}

// ================================
// VERSIONING (Board Snapshots)
// ================================

model BoardSnapshot {
  id              String   @id @default(uuid())
  boardId         String
  snapshotJson    Json // Full board state: nodes, positions, groups, edges
  createdAt       DateTime @default(now())
  createdByUserId String?

  // Relations
  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([createdAt])
}

// ================================
// JOB TRACKING (Optional - for UI feedback)
// ================================

model Job {
  id        String    @id @default(uuid())
  type      String    // e.g., "youtube_ingestion", "web_scraping", "document_processing"
  nodeId    String?   // Associated node if applicable
  boardId   String?
  status    JobStatus @default(PENDING)
  progress  Int       @default(0) // 0-100
  error     String?   @db.Text
  result    Json?     // Result data
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([nodeId])
  @@index([boardId])
  @@index([status])
  @@index([createdAt])
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ================================
// BUSINESS IDEAS (Generated & Saved Ideas)
// ================================

model BusinessIdea {
  id                    String               @id @default(uuid())
  userId                String
  title                 String
  date                  DateTime
  tags                  String[]             // PostgreSQL array for tags
  description           String               @db.Text
  priceRange            String
  trendKeyword          String
  trendVolume           String?
  trendGrowth           String?
  relatedKeywords       String[]             // PostgreSQL array for keywords
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  // Relations
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  trendData             TrendDataPoint[]
  kpi                   BusinessIdeaKPI?
  businessFit           BusinessIdeaFit?
  sections              BusinessIdeaSections?
  communitySignals      BusinessIdeaCommunitySignals?
  sources               BusinessIdeaSource[]
  valueLadder           ValueLadderStep[]
  shares                IdeaShare[]          // Ideas shared by this user
  comments              IdeaComment[]
  collections           CollectionIdea[]     // Collections this idea belongs to
  generationLogs        IdeaGenerationLog[]

  @@index([userId])
  @@index([createdAt])
  @@index([trendKeyword])
}

// Trend Data Points
model TrendDataPoint {
  id            String       @id @default(uuid())
  businessIdeaId String
  date          String       // e.g., "2024", "Q1 2024"
  value         Float
  createdAt     DateTime     @default(now())

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)

  @@index([businessIdeaId])
}

// KPI Scores
model BusinessIdeaKPI {
  id            String       @id @default(uuid())
  businessIdeaId String      @unique

  opportunityScore   Int
  opportunityLabel   String
  problemScore       Int
  problemLabel       String
  feasibilityScore   Int
  feasibilityLabel   String
  whyNowScore        Int
  whyNowLabel        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
}

// Business Fit Analysis
model BusinessIdeaFit {
  id            String       @id @default(uuid())
  businessIdeaId String      @unique

  revenuePotential                String
  revenuePotentialDescription     String?  @db.Text
  executionDifficulty             Int      // 1-10 scale
  executionDifficultyDescription  String?  @db.Text
  goToMarket                      Int      // 1-10 scale
  goToMarketDescription           String?  @db.Text
  founderFitDescription           String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
}

// Business Sections (Analysis)
model BusinessIdeaSections {
  id            String       @id @default(uuid())
  businessIdeaId String      @unique

  whyNow         String       @db.Text
  proofAndSignals String      @db.Text
  marketGap      String       @db.Text
  executionPlan  String       @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
}

// Community Signals
model BusinessIdeaCommunitySignals {
  id            String       @id @default(uuid())
  businessIdeaId String      @unique

  reddit    String?  @db.Text
  facebook  String?  @db.Text
  youtube   String?  @db.Text
  other     String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
}

// AI Grounding Sources
model BusinessIdeaSource {
  id            String       @id @default(uuid())
  businessIdeaId String

  title String
  uri   String

  createdAt DateTime @default(now())

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)

  @@index([businessIdeaId])
}

// Value Ladder Steps
model ValueLadderStep {
  id            String       @id @default(uuid())
  businessIdeaId String

  type           String      // e.g., 'Lead Magnet', 'Frontend Offer', 'Core Offer', 'Continuity Program', 'Backend Offer'
  title          String
  description    String      @db.Text
  price          String
  valueProvided  String      @db.Text  // The specific value to the customer
  goal           String      @db.Text  // The strategic goal of this step

  order         Int          @default(0)  // Order in the value ladder

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)

  @@index([businessIdeaId])
  @@index([businessIdeaId, order])
}

// ================================
// USER PREFERENCES & SETTINGS
// ================================

model UserPreferences {
  id                    String   @id @default(uuid())
  userId                String   @unique

  // Idea Generation Preferences
  preferredIndustries   String[] // PostgreSQL array
  preferredBusinessModels String[] // PostgreSQL array
  riskTolerance        Int?     // 1-10 scale
  budgetRange          String[] // PostgreSQL array

  // UI Preferences
  theme                String   @default("light") // "light", "dark", "auto"
  defaultView          String   @default("home")  // "home", "my-ideas", "whiteboard"
  notificationsEnabled Boolean  @default(true)

  // AI Settings
  aiTemperature        Float    @default(0.7)
  maxTokens           Int      @default(4096)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ================================
// IDEA COLLECTIONS & FAVORITES
// ================================

model IdeaCollection {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?  @db.Text
  isPublic    Boolean  @default(false)
  tags        String[] // PostgreSQL array for collection tags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  ideas       CollectionIdea[]

  @@index([userId])
  @@index([isPublic])
}

model CollectionIdea {
  id            String   @id @default(uuid())
  collectionId  String
  businessIdeaId String
  addedAt       DateTime @default(now())

  // Relations
  collection   IdeaCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  businessIdea BusinessIdea   @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)

  @@unique([collectionId, businessIdeaId])
  @@index([collectionId])
  @@index([businessIdeaId])
}

// ================================
// IDEA SHARING & COMMENTS
// ================================

model IdeaShare {
  id            String   @id @default(uuid())
  businessIdeaId String
  sharedByUserId String
  sharedWithUserId String?
  shareToken    String  @unique // For public sharing
  isPublic      Boolean @default(false)
  canEdit       Boolean @default(false)
  expiresAt     DateTime?
  createdAt     DateTime @default(now())

  // Relations
  businessIdea  BusinessIdea @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
  sharedBy      User         @relation("SharedBy", fields: [sharedByUserId], references: [id])
  sharedWith    User?        @relation("SharedWith", fields: [sharedWithUserId], references: [id], onDelete: SetNull)

  @@index([businessIdeaId])
  @@index([shareToken])
  @@index([expiresAt])
}

model IdeaComment {
  id            String   @id @default(uuid())
  businessIdeaId String
  userId        String
  parentId      String?  // For threaded comments
  content       String   @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  businessIdea BusinessIdea  @relation(fields: [businessIdeaId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent       IdeaComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies      IdeaComment[] @relation("CommentThread")

  @@index([businessIdeaId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

// ================================
// ANALYTICS & USAGE TRACKING
// ================================

model IdeaGenerationLog {
  id            String   @id @default(uuid())
  userId        String
  businessIdeaId String?

  // Request details
  prompt        String?  @db.Text
  modelUsed     String   // e.g., "gemini-3-pro-preview"
  tokensUsed    Int?

  // Response details
  success       Boolean
  errorMessage  String?  @db.Text

  // Timing
  processingTimeMs Int?
  createdAt       DateTime @default(now())

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessIdea BusinessIdea? @relation(fields: [businessIdeaId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([businessIdeaId])
  @@index([createdAt])
}
